<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self'; style-src 'unsafe-inline' 'self'; connect-src 'self'; img-src 'self' data: blob:; media-src 'self' blob:; base-uri 'none'; form-action 'self'; frame-ancestors 'none'">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Onion DM</title>
  <style>
    :root{
      --bg:#0a0b10; --bg2:#0e1018; --panel:#121526; --panel2:#0f1220;
      --muted:#9aa0a6; --text:#e9ecf1; --accent:#5b7cfe; --accent-2:#7aa2ff;
      --ok:#18a957; --warn:#ff9b5e;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      color-scheme: dark;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:
        radial-gradient(1200px 800px at -10% -20%, #1b1635 0%, transparent 60%),
        radial-gradient(1000px 700px at 120% 10%, #10253d 0%, transparent 60%),
        var(--bg);
      color:var(--text);
      font:14px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif;
    }
    a{color:var(--accent); text-decoration:none}
    .hidden{display:none !important}
    .sr{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* Buttons / inputs (big, tappable) */
    input,button,textarea{
      border-radius:12px; border:1px solid #2a2f49; background:#12162b; color:var(--text);
      padding:12px 14px; font-size:14px; outline:none; min-height:44px;
    }
    input::placeholder{color:#74809a}
    input:disabled, button:disabled{opacity:.55; cursor:not-allowed}
    button{cursor:pointer}
    .btn{background:#171c35}
    .btn.primary{background:linear-gradient(180deg, var(--accent) 0%, var(--accent-2) 100%); border-color:#6e8bff; color:white}
    .btn.ghost{background:transparent}
    .btn.ok{background:#143023; border-color:#1d5136; color:#9ef3b8}
    .btn.warn{background:#2a140e; border-color:#4a2415; color:#ffb69a}
    .copy{font-size:12px}
    .iconbtn{background:#0c1030;border:1px solid #202446;border-radius:10px;padding:6px 8px;min-height:auto}
    .iconbtn.warn{background:#2a1511;border-color:#4d291f}

    /* Cards / layout primitives */
    .card{
      background:linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
      border:1px solid #1c2037; border-radius:18px; padding:18px; box-shadow:var(--shadow)
    }
    .glass{
      background:linear-gradient(180deg, rgba(18,21,38,.75), rgba(15,18,32,.75));
      backdrop-filter: blur(8px);
    }
    .spaced{display:flex; flex-direction:column; gap:14px}
    .title{font-size:22px; font-weight:700}
    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row > *:is(input,button){flex:1}
    .row .shrink{flex:0 0 auto}
    .badge{color:var(--muted); font-size:12px}

    .idbox{
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      background:#0d1122; border:1px dashed #2a2f49; padding:10px 12px; border-radius:12px; word-break:break-all
    }

    /* App bar */
    header.appbar{
      height:56px; display:flex; align-items:center; justify-content:space-between;
      padding:0 12px; background:linear-gradient(180deg, #14172b 0%, #111423 100%);
      border-bottom:1px solid #1d2137; position:sticky; top:0; z-index:20;
    }
    .brand{font-size:15px; font-weight:700; letter-spacing:.3px; display:flex; gap:8px; align-items:center}
    .menu-btn{display:none}

    /* Views */
    .view{min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px}
    .center-col{width:100%; max-width:980px; display:flex; gap:24px; align-items:stretch}
    .hero{max-width:520px; margin:auto; text-align:center}
    .hero h1{font-size:clamp(22px, 3vw, 30px); margin:0 0 6px}
    .cta{display:flex; gap:12px; justify-content:center; margin-top:14px; flex-wrap:wrap}

    /* App shell grid */
    .shell{display:grid; grid-template-columns:320px 1fr; gap:18px; width:100%; max-width:1200px}
    .sidebar{display:flex; flex-direction:column; gap:18px}
    .section{display:flex; flex-direction:column; gap:10px}
    .list{display:flex; flex-direction:column; gap:8px; max-height:calc(100vh - 56px - 18px - 18px - 320px); overflow:auto}
    .contact{
      display:flex; align-items:center; gap:8px; padding:12px 12px; cursor:pointer;
      border:1px solid #22284a; border-radius:12px; background:#0e142a;
    }
    .contact.active{outline:2px solid var(--accent)}
    .grow{flex:1}
    .count{background:#244; border:1px solid #335; color:#cfe6ff; padding:2px 6px; border-radius:999px; font-size:12px}
    .contact .actions{display:flex; gap:6px}

    /* Chat panel */
    .chat{display:flex; flex-direction:column; gap:14px; min-height:calc(100vh - 56px - 56px)}
    .thread{flex:1; min-height:40vh; max-height:calc(100vh - 56px - 24px - 210px);
      overflow:auto; display:flex; flex-direction:column; gap:10px; padding:16px}
    .bubble{max-width:70ch; padding:10px 12px; border-radius:14px; border:1px solid #202646; background:#0e1330}
    .me{align-self:flex-end; background:#111a3f}
    .them{align-self:flex-start}
    .timestamp{font-size:11px; color:var(--muted); margin-top:4px}
    .composer{display:flex; gap:10px; padding:12px; border-top:1px solid #1d213e; position:sticky; bottom:0;
      padding-bottom:calc(12px + env(safe-area-inset-bottom))}
    .composer input{flex:1}

    .pill{border:1px solid #2a2e46; background:#0f1430; color:#b9c3ff; padding:4px 8px; border-radius:999px; font-size:12px}
    .pill.ok{background:#142a1f; color:#a4f0b7; border-color:#1f4a31}
    .pill.warn{background:#2a1511; color:#ffb19b; border-color:#4d291f}
    .mini{font-size:12px; color:var(--muted)}
    #fpRow{overflow:auto; white-space:nowrap}

    /* Toast */
    #toast{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; z-index:50;
      background:#0f1430; border:1px solid #2a2e46; color:#e9ecf1; padding:10px 14px; border-radius:12px; box-shadow:var(--shadow); display:none}

    /* Mobile responsive (Bootstrap-ish breakpoints) */
    @media (max-width: 992px){
      .shell{grid-template-columns:1fr}
      .menu-btn{display:inline-flex; align-items:center; gap:8px}
      /* Sidebar becomes a drawer */
      .sidebar{
        position:fixed; top:56px; left:0; height:calc(100vh - 56px);
        width:min(92vw, 360px); padding:14px; overflow:auto;
        background:linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
        border-right:1px solid #1c2037; transform:translateX(-100%); transition:transform .22s ease;
        z-index:30;
      }
      .sidebar.open{ transform:translateX(0) }
      .backdrop{
        position:fixed; inset:56px 0 0 0; background:rgba(0,0,0,.45); backdrop-filter: blur(2px);
        display:none; z-index:25;
      }
      .backdrop.show{display:block}
      .list{max-height:unset}
    }
    @media (max-width: 640px){
      .row > *:is(input,button){flex:1 1 100%}
      .thread{max-height:none; min-height:50vh}
      .hero h1{font-size:24px}
    }
  </style>
  <script src="app.js" defer></script>
</head>
<body>

<!-- ===== Landing (choose) ===== -->
<section id="view-landing" class="view">
  <div class="center-col">
    <div class="card glass hero">
      <h1>ðŸ§… Onion DM</h1>
      <div class="muted">Private, end-to-end encrypted DMs over Tor with key pinning.</div>
      <div class="cta">
        <button id="btnLandingLogin" class="btn">Log in (Import)</button>
        <button id="btnLandingSignup" class="btn primary">Sign up (Create new)</button>
      </div>
    </div>
  </div>
</section>

<!-- ===== Login (import) ===== -->
<section id="view-login" class="view hidden">
  <div class="center-col">
    <div class="card spaced" style="max-width:680px; margin:auto">
      <div class="title">Log in to existing ID</div>
      <div class="muted">Import your encrypted identity backup file.</div>
      <div class="row">
        <input id="loginPass" type="password" placeholder="Passphrase"/>
        <input id="loginFile" class="shrink" type="file" accept="application/json"/>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button id="btnBackFromLogin" class="btn ghost">Back</button>
        <button id="btnLoginImport" class="btn primary">Import & continue</button>
      </div>
      <div class="mini">Lost your file? Create a new ID instead.</div>
    </div>
  </div>
</section>

<!-- ===== Post-signup export onboarding ===== -->
<section id="view-export" class="view hidden">
  <div class="center-col">
    <div class="card spaced" style="max-width:720px; margin:auto">
      <div class="title">You're signed up âœ…</div>
      <div class="muted">This is your ID. Share it so others can add you.</div>
      <div class="row">
        <div id="onbMyId" class="idbox" style="flex:1"></div>
        <button id="btnOnbCopy" class="copy btn">Copy</button>
      </div>
      <hr style="border:0; border-top:1px solid #22294d">
      <div class="title" style="font-size:18px">Recommended: back up your identity</div>
      <div class="muted">Export an <em>encrypted</em> backup so you can log in later even if the browser forgets data.</div>
      <div class="row">
        <input id="onbPass" type="password" placeholder="Choose a passphrase (8+ chars)"/>
        <button id="btnOnbExport" class="btn ok">Export now</button>
        <button id="btnOnbSkip" class="btn ghost">Skip for now</button>
      </div>
    </div>
  </div>
</section>

<!-- ===== App shell (main UI) ===== -->
<section id="view-app" class="hidden">
  <header class="appbar">
    <button id="btnToggleSidebar" class="btn menu-btn" aria-controls="sidebar" aria-expanded="false">
      <span aria-hidden="true">â˜°</span><span class="sr">Toggle menu</span>
    </button>
    <div class="brand">ðŸ§… Onion DM</div>
    <div id="userBadge" class="badge"></div>
  </header>

  <div id="backdrop" class="backdrop"></div>

  <div class="view" style="align-items:flex-start">
    <div class="shell">
      <!-- Sidebar (becomes drawer on mobile) -->
      <aside id="sidebar" class="sidebar" aria-label="Sidebar">
        <div class="card section">
          <div class="muted">Your ID</div>
          <div class="row">
            <div id="myId" class="idbox"></div>
            <button id="copyId" class="copy btn">Copy</button>
          </div>
        </div>

        <div class="card section">
          <div class="muted">Add contact by ID</div>
          <div class="row">
            <input id="contactId" placeholder="Enter ID"/>
            <button id="btnAddContact" class="btn">Add</button>
          </div>
        </div>

        <div class="card section">
          <div class="muted">Notifications</div>
          <label class="row" style="justify-content:space-between">
            <span>Desktop notifications</span>
            <input id="toggleDesktop" class="shrink" type="checkbox"/>
          </label>
          <label class="row" style="justify-content:space-between">
            <span>Sound on new message</span>
            <input id="toggleSound" class="shrink" type="checkbox"/>
          </label>
        </div>

        <div class="card section">
          <div class="muted">Backup & restore</div>
          <div class="row">
            <input id="backupPass" type="password" placeholder="Export passphrase"/>
            <button id="btnExport" class="btn">Export</button>
          </div>
          <div class="row">
            <input id="restorePass" type="password" placeholder="Import passphrase"/>
            <input id="restoreFile" class="shrink" type="file" accept="application/json"/>
            <button id="btnImport" class="btn">Import</button>
          </div>
        </div>

        <div class="card section">
          <div class="muted">Contacts</div>
          <div id="contactsList" class="list"></div>
        </div>

        <div class="card section">
          <div class="muted">Groups</div>
          <div class="row">
            <input id="groupName" placeholder="Create: group name"/>
            <button id="btnCreateGroup" class="btn">Create</button>
          </div>
          <div class="row">
            <input id="groupIdJoin" placeholder="Join by Group ID"/>
            <button id="btnJoinGroup" class="btn">Join</button>
          </div>
          <div id="groupsList" class="list"></div>
        </div>
      </aside>

      <!-- Chat area -->
      <div class="card chat">
        <div id="noChat" class="spaced" style="align-items:center; justify-content:center; min-height:200px">
          <div class="title" style="font-size:18px">Select a contact to start chatting</div>
          <div class="muted">Or add a new contact using their ID.</div>
        </div>

        <div id="chatHeader" class="hidden">
          <div class="row" style="align-items:center">
            <span class="muted">Chat with</span>
            <span id="peerLabel" class="pill"></span>
            <span id="keyBadge" class="pill warn hidden"></span>
            <button id="btnTrustKey" class="btn copy hidden">Trust key</button>
          </div>
          <div id="fpRow" class="row hidden">
            <span class="muted">Fingerprints</span>
            <span id="encFp" class="idbox"></span>
            <span id="sigFp" class="idbox"></span>
            <span class="mini">Verify out-of-band, then trust.</span>
          </div>
          <div id="groupRow" class="row hidden" style="align-items:flex-start; gap:8px;">
            <span class="muted">Members</span>
            <div id="membersList" class="grow" style="display:flex; flex-wrap:wrap; gap:6px"></div>
            <button id="btnLeaveGroup" class="btn warn hidden">Leave group</button>
            <span id="groupHint" class="mini">Owner can rename or remove members.</span>
          </div>
        </div>

        <div id="thread" class="thread"></div>

        <div id="uploadRow" class="row hidden" style="align-items:center; gap:10px; padding:0 16px 8px;">
          <progress id="uploadBar" value="0" max="100" style="flex:1"></progress>
          <span id="uploadLabel" class="muted" style="min-width:120px"></span>
          <button id="btnUploadCancel" class="btn warn">Cancel</button>
        </div>

        <div id="downloadRow" class="row hidden" style="align-items:center; gap:10px; padding:0 16px 8px;">
          <progress id="downloadBar" value="0" max="100" style="flex:1"></progress>
          <span id="downloadLabel" class="muted" style="min-width:120px"></span>
          <button id="btnDownloadCancel" class="btn warn">Cancel</button>
        </div>

        <div class="composer">
          <input id="msgInput" placeholder="Type a message... (Enter to send, Shift+Enter = newline)"/>
          <div class="row" style="gap:8px; flex:0 0 auto">
            <button id="btnAttach" class="btn">Attach</button>
            <button id="btnSend" class="btn primary">Send</button>
          </div>
          <input id="fileInput" type="file" class="hidden" />
        </div>
      </div>
    </div>
  </div>
</section>

<div id="toast" role="status" aria-live="polite"></div>

</body>
</html>
